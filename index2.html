<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Pantau Pembelajaran Santri</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      max-width: 500px;
      margin-bottom: 20px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 10px;
      padding: 10px 16px;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0b5ed7; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #0d6efd;
      color: white;
    }
    #progress {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    .reported {
      color: gray;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h2>Aplikasi Pantau Pembelajaran Santri</h2>

  <form id="formSantri">
    <input type="text" id="stambuk" placeholder="Stambuk" required>
    <input type="text" id="nama" placeholder="Nama Santri" required>
    <input type="text" id="kelas" placeholder="Kelas" required>
    <input type="text" id="daerah" placeholder="Daerah" required>
    <input type="text" id="ustadz" placeholder="Ustadz Pembimbing" required>

    <select id="jenis" required>
      <option value="">-- Jenis Kegiatan --</option>
      <option value="Teori">Teori</option>
      <option value="Praktek">Praktek</option>
      <option value="Hafalan">Hafalan</option>
    </select>

    <select id="pelajaran" required></select>
  </form>

  <table id="tabelMateri" style="display:none;">
    <thead>
      <tr><th>No</th><th>Judul Materi</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="btnSimpan">Simpan</button>
  <div id="progress"></div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwRi0I23_Gqlm1bBW9xpQTToem_d0K8O9r9PS9jfwtfB08wvK-uhxRYcAmTd08cw_iArg/exec";
    const pelajaranSelect = document.getElementById("pelajaran");
    const tabel = document.getElementById("tabelMateri");
    const tbody = tabel.querySelector("tbody");
    let progressSantri = []; // simpan laporan lama

    // === 1. Ambil daftar pelajaran dari Google Sheet ===
    async function loadPelajaran() {
      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({ action: "getPelajaran" })
        });
        const data = await res.json();

        pelajaranSelect.innerHTML = `<option value="">-- Pilih Pelajaran --</option>`;
        Object.keys(data).forEach(p => {
          pelajaranSelect.innerHTML += `<option value="${p}">${p}</option>`;
        });

        pelajaranSelect.addEventListener("change", () => {
          const pel = pelajaranSelect.value;
          tbody.innerHTML = "";

          if (data[pel]) {
            tabel.style.display = "table";

            // Ambil daftar judul yang sudah dilaporkan untuk pelajaran ini
            const judulSudah = progressSantri
              .filter(p => p.pelajaran === pel)
              .map(p => p.judul);

            data[pel].forEach((m, i) => {
              const sudah = judulSudah.includes(m.id);
              if (sudah) {
                tbody.innerHTML += `
                  <tr class="reported">
                    <td>${i + 1}</td>
                    <td>${m.judul}</td>
                    <td>âœ” Telah dilaporkan</td>
                  </tr>`;
              } else {
                tbody.innerHTML += `
                  <tr>
                    <td>${i + 1}</td>
                    <td>${m.judul}</td>
                    <td><input type="checkbox" value="${m.id}"></td>
                  </tr>`;
              }
            });
          } else {
            tabel.style.display = "none";
          }
        });
      } catch (err) {
        alert("Gagal memuat daftar pelajaran: " + err.message);
      }
    }
    loadPelajaran();

    // === 2. Simpan data ===
    document.getElementById("btnSimpan").addEventListener("click", async () => {
      const judulDipilih = [...tbody.querySelectorAll("input:checked")].map(x => x.value);
      const data = {
        stambuk: stambuk.value.trim(),
        nama: nama.value.trim(),
        kelas: kelas.value.trim(),
        daerah: daerah.value.trim(),
        ustadz: ustadz.value.trim(),
        jenis: jenis.value,
        pelajaran: pelajaranSelect.value,
        judul: judulDipilih
      };

      if (!data.stambuk || !data.nama || !data.pelajaran || data.judul.length === 0) {
        alert("Lengkapi semua kolom dan pilih minimal satu judul materi.");
        return;
      }

      try {
        btnSimpan.disabled = true;
        btnSimpan.textContent = "Menyimpan...";
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({ action: "simpanData", data })
        });
        const hasil = await res.json();
        alert(hasil.message || "Data berhasil disimpan!");
        btnSimpan.disabled = false;
        btnSimpan.textContent = "Simpan";

        // reset tabel dan reload progress
        pelajaranSelect.dispatchEvent(new Event("change"));
        document.getElementById("stambuk").dispatchEvent(new Event("blur"));
      } catch (err) {
        alert("Gagal menyimpan: " + err.message);
        btnSimpan.disabled = false;
        btnSimpan.textContent = "Simpan";
      }
    });

    // === 3. Cek progress otomatis saat isi stambuk ===
    document.getElementById("stambuk").addEventListener("blur", async () => {
      const stambukVal = stambuk.value.trim();
      if (!stambukVal) return;
      const div = document.getElementById("progress");
      div.innerHTML = "Memuat progress...";

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({ action: "getProgress", stambuk: stambukVal })
        });
        const rows = await res.json();
        progressSantri = rows; // simpan ke variabel global

        if (rows.length === 0) {
          div.innerHTML = "<p>Belum ada progress.</p>";
        } else {
          div.innerHTML = "<h4>Progress Sebelumnya:</h4><ul>" + 
            rows.map(r => `<li>${r.tanggal} - ${r.pelajaran} (${r.judul}) [${r.jenis}]</li>`).join("") +
            "</ul>";
        }
      } catch (err) {
        div.innerHTML = "<p style='color:red'>Gagal memuat progress: " + err.message + "</p>";
      }
    });
  </script>
</body>
</html>
